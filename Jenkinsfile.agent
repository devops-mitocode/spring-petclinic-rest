pipeline {
  agent none
  environment {
    GH_TOKEN = credentials('github-copilot-cli-token')
  }
  stages {

    stage('Build (Maven)') {
      agent {
        docker {
          image 'maven:3.9.9-eclipse-temurin-17-alpine'
          reuseNode true
        }
      }
      steps {
          sh "mvn -U -B -ntp clean package -DskipTests"
      }
    }

    stage('AI Agent Analysis') {
      agent {
        docker {
          image 'ghcr.io/supportpal/github-gh-cli:2.87.3'
          args '-e HOME=/tmp -e XDG_CONFIG_HOME=/tmp/.config -e XDG_DATA_HOME=/tmp/.local/share'
          reuseNode true
        }
      }
      steps {
        sh '''
          set -e

          echo "Validando autenticación..."
          gh auth status

          echo "Instalando Copilot CLI si no está..."
          gh extension install github/gh-copilot || true

          echo "Probando Copilot..."
          gh copilot explain "Explain what an AI agent does in a Jenkins pipeline."
        '''        
      }
    }
  }
}