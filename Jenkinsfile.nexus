pipeline {
    agent {
        docker {
            image 'maven:3.9.11-eclipse-temurin-17'
        }
    }
    // environment {
    //     ARTIFACTORY_CREDENTIALS = credentials('artifactory-credentials')
    // }
    stages {  
        stage('Package') {
            steps {
                sh 'mvn clean package -U -B -DskipTests'
            }
        }
        stage('Nexus') {
            steps {
                script {

                    sh 'env | sort'

                    def pom = readMavenPom file: 'pom.xml'
                    println pom

                    writeFile file: "target/build-info.properties", text: """
                        url=${env.RUN_DISPLAY_URL}
                        user=${env.USER}
                        """.trim()

                    nexusPublisher nexusInstanceId: 'nexus',
                    nexusRepositoryId: 'spring-petclinic-rest-release',
                    packages: [[$class: 'MavenPackage',
                        mavenAssetList: [[
                            classifier: '', 
                            extension: '', 
                            filePath: "target/${pom.artifactId}-${pom.version}.${pom.packaging}"
                            ],
                            [
                                classifier: 'build-info',
                                extension: 'properties',
                                filePath: "target/build-info.properties"
                            ]
                        ],
                        mavenCoordinate: [
                            groupId: "${pom.groupId}",
                            artifactId: "${pom.artifactId}",
                            packaging: "${pom.packaging}",
                            version: "${pom.version}"
                        ]
                    ]]


                }
            }
        }
    }
    post {
        success {
            archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
        }
        cleanup {
            cleanWs()
        }
    }
}